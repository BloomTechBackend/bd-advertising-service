<?xml version="1.0"?>

<project xmlns:ht="happytrails">
    <macrodef name="validateClasspathWithIgnore">
        <attribute name="classpath" default="${bp:run.classpath}"/>
        <attribute name="failOnConflicts" default="true"/>
        <attribute name="ignoreConflictsFilePath" default="${basedir}/validate-classpath.ignore" />
        <sequential>
            <loadfile property="file" srcfile="@{ignoreConflictsFilePath}"/>
            <var name="filterExp" unset="true" />
            <for param="line" list="${file}" delimiter="${line.separator}">
                <sequential>
                    <if>
                        <!-- ignores lines that start with a # -->
                        <matches string="@{line}" pattern="^[^#].*$" />
                        <then>
                            <echo>Excluding from validation packages matching: '@{line}'</echo>
                            <if>
                                <isset property="filterExp" />
                                <then>
                                    <var name="filterExp" value="${filterExp}|.*@{line}" />
                                </then>
                                <else>
                                    <var name="filterExp" value=".*@{line}" />
                                </else>
                            </if>
                        </then>
                    </if>
                </sequential>
            </for>
            <if>
                <isset property="filterExp" />
                <then>
                    <echo level="debug">Classpath filter: '${filterExp}'</echo>
                    <pathconvert property="filteredClasspath">
                        <path path="@{classpath}" />
                        <regexpmapper from="^(?!${filterExp}).*$" to="\0" />
                    </pathconvert>
                </then>
                <else>
                    <property name="filteredClasspath" value="@{classpath}" />
                </else>
            </if>
            <echo level="debug">Classpath to validate: ${filteredClasspath}</echo>
            <ht:validateClasspath classpath="${filteredClasspath}" failOnConflicts="@{failOnConflicts}"/>
        </sequential>
    </macrodef>
</project>
